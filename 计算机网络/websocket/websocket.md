# websocket

## 1.socket、websocket

- 单工通信：单工通信只支持信号在一个方向上传输（正向或反向），任何时候不能改变信号的传输方向。

- 半双工通信：半双工通信允许信号在两个方向上传输，但某一时刻只允许信号在一个信道上单向传输。

- 全双工通信：双方可同时向对方发送消息。

在网络中的两个应用程序（进程）需要全双工相互通信，需要用到的就是socket，它能够提供端对端通信。对于程序员只需要在客户端创建一个socket实例并且连接到服务端的ip地址和端口，在服务端创建另一个socket并绑定本地端口进行监听，然后客户端连接服务端，服务端接收连接之后双方建立端到端的tcp连接，在该连接的基础上可以进行端到端的通信。在建立通讯以后实际上就没有客户端和服务端之分了，提供的就是端到端的通讯，从本质上来说，socket并不是一个新的协议，它只是为了便于程序员进行网络编程而对tcp/ip协议族通信机制的一种封装。

websocket是html5规范中的一个部分，它借鉴了socket这种思想，为web应用程序客户端和服务端之间（注意是客户端服务端）提供了一种全双工通信机制。同时，它又是一种新的应用层协议，websocket协议是为了提供web应用程序和服务端全双工通信而专门制定的一种应用层协议，通常它表示为：ws://echo.websocket.org/?encoding=text HTTP/1.1，可以看到除了前面的协议名和http不同之外，它的表示地址就是传统的url地址。

## 2.websocket通信原理机制

既然是基于浏览器端的web技术，那么它的通信肯定少不了http,websocket本身虽然也是一种新的应用层协议，但是它也不能够脱离http而单独存在。具体来讲，我们在客户端构建一个websocket实例，并且为它绑定一个需要连接到的服务器地址，当客户端连接服务端的时候，会向服务端发送一个类似下面的http报文：

![image-20211107120317933](C:\Users\86155\AppData\Roaming\Typora\typora-user-images\image-20211107120317933.png)

可以看到，这是一个http  get请求报文，注意该报文中有一个upgrade首部，它的作用是告诉服务端需要将通信协议切换到websocket,如果服务端支持websocket协议，那么它就会将自己的通信协议切换到websocket,同时发给客户端类似于以下的一个响应报文头：

![image-20211107120407715](C:\Users\86155\AppData\Roaming\Typora\typora-user-images\image-20211107120407715.png)

返回的状态码为101，表示同意客户端协议转换请求，并将它转换为websocket协议。以上过程都是利用http通信完成的，称之为websocket协议握手(websocket Protocol handshake)，进过这握手之后，客户端和服务端就建立了websocket连接，以后的通信走的都是websocket协议了。所以总结为websocket握手需要借助于http协议，建立连接后通信过程使用websocket协议。同时需要了解的是，该websocket连接还是基于我们刚才发起http连接的那个TCP连接。一旦建立连接之后，我们就可以进行数据传输了，websocket提供两种数据传输：文本数据和二进制数据。



